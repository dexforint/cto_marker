# Модуль для управления размерами батчей и количеством воркеров
# Определяет оптимальные параметры обработки на основе доступных ресурсов GPU

from marker.utils.gpu import GPUManager


def get_batch_sizes_worker_counts(gpu_manager: GPUManager, peak_worker_vram: int):
    """
    Вычисляет оптимальные размеры батчей и количество воркеров на основе доступной видеопамяти.
    
    Функция анализирует доступную VRAM и определяет, сколько параллельных процессов
    может выполняться одновременно, а также устанавливает оптимальные размеры батчей
    для различных этапов обработки документов.
    
    Логика работы:
    1. Получаем доступную видеопамять
    2. Рассчитываем максимальное количество воркеров
    3. Если воркер только один, возвращаем пустые настройки
    4. Иначе возвращаем оптимальные размеры батчей для каждого компонента
    
    Аргументы:
        gpu_manager: Менеджер для работы с GPU и получения информации о памяти
        peak_worker_vram: Пиковое потребление VRAM одним воркером в мегабайтах
    
    Возвращает:
        tuple: (настройки_батчей, количество_воркеров)
        - настройки_батчей: словарь с размерами батчей для разных компонентов
        - количество_воркеров: оптимальное число параллельных процессов
    """
    # Получаем доступную видеопамять в мегабайтах
    vram = gpu_manager.get_gpu_vram()

    # Рассчитываем максимальное количество воркеров
    # Используем целочисленное деление для определения количества процессов
    workers = max(1, vram // peak_worker_vram)
    
    # Если доступен только один воркер, не настраиваем размеры батчей
    # (будет использоваться значение по умолчанию)
    if workers == 1:
        return {}, workers

    # Возвращаем оптимальные размеры батчей для различных компонентов
    # Эти значения подобраны эмпирически для эффективного использования GPU
    return {
        "layout_batch_size": 12,          # Размер батча для определения структуры страницы
        "detection_batch_size": 8,        # Размер батча для детекции текстовых регионов
        "table_rec_batch_size": 12,       # Размер батча для распознавания таблиц
        "ocr_error_batch_size": 12,       # Размер батча для определения ошибок OCR
        "recognition_batch_size": 64,     # Размер батча для распознавания текста (самый тяжелый)
        "equation_batch_size": 16,        # Размер батча для распознавания формул
        "detector_postprocessing_cpu_workers": 2,  # Количество CPU воркеров для постобработки
    }, workers